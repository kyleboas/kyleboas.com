name: Post Latest Blog from RSS to Bluesky

on:
  push:
    paths:
      - _posts/**
  workflow_dispatch:

jobs:
  fetch-and-post:
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York  # force local time for all `date` calls

    steps:
      # Optional delay
      - name: Initial Delay
        run: |
          echo "Waiting for 1 minute before starting..."
          sleep 60

      # Tools
      - name: Install xmllint
        run: |
          sudo apt-get update && sudo apt-get install -y libxml2-utils

      # Fetch & parse RSS
      - name: Fetch Latest Blog Post
        id: fetch_post
        shell: bash
        run: |
          set -euo pipefail

          RSS_FEED_URL="https://kyleboas.com/feed"
          echo "Fetching RSS: $RSS_FEED_URL"
          response="$(curl -fsSL "$RSS_FEED_URL")"

          # Extract first item (masked for log readability)
          first_item="$(echo "$response" | xmllint --xpath "//item[1]" - 2>/dev/null || true)"
          echo "First <item> snippet (link masked):"
          echo "$first_item" | sed -e 's/<link>.*<\/link>/<link>â€¦<\/link>/'

          title="$(echo "$response"    | xmllint --xpath "string(//item[1]/title)"   - 2>/dev/null || true)"
          guid_url="$(echo "$response" | xmllint --xpath "string(//item[1]/guid[@isPermaLink='true'])" - 2>/dev/null || true)"
          link_url="$(echo "$response" | xmllint --xpath "string(//item[1]/link)"    - 2>/dev/null || true)"
          pub_date="$(echo "$response" | xmllint --xpath "string(//item[1]/pubDate)" - 2>/dev/null || true)"

          if [[ -z "${title// }" || ( -z "${guid_url// }" && -z "${link_url// }" ) || -z "${pub_date// }" ]]; then
            echo "Error: Missing one or more required fields."
            echo "title=[$title]"
            echo "guid_url=[$guid_url]"
            echo "link_url=[$link_url]"
            echo "pub_date=[$pub_date]"
            exit 1
          fi

          # Compare by YYYY-MM-DD in local time
          pub_day_local="$(TZ="America/New_York" date -d "$pub_date" +%Y-%m-%d)"
          today_local="$(TZ="America/New_York" date +%Y-%m-%d)"
          echo "Publication Day (local): $pub_day_local"
          echo "Today's Day (local):     $today_local"

          if [[ "$pub_day_local" != "$today_local" ]]; then
            echo "The latest post is not from today (local). Skipping Bluesky post."
            echo "has_today_post=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # ------- URL CHOICE + SANITIZATION + VALIDATION -------
          # Prefer GUID(permalink) if present; otherwise fall back to <link>
          url_raw="${guid_url:-$link_url}"

          # Remove control chars, CRs, extra newlines; trim
          url_clean="$(printf '%s' "$url_raw" \
            | tr -d '\000-\037\177' \
            | tr -d '\r' \
            | tr -s '\n' \
            | xargs)"

          # Optionally resolve redirects to final URL (if any)
          final_url="$(curl -fsSL -o /dev/null -w '%{url_effective}' "$url_clean" || true)"
          url="${final_url:-$url_clean}"

          # Re-trim just in case
          url="$(printf '%s' "$url" | tr -d '\r' | tr -s '\n' | xargs)"

          # Validate shape; only use for embed if it's a proper http(s) URI with no spaces
          if echo "$url" | grep -Eq '^https?://[^[:space:]]+$'; then
            echo "link_preview_url=$url" >> "$GITHUB_ENV"
          else
            echo "Warning: URL failed URI check for embed: [$url]"
            echo "link_preview_url=" >> "$GITHUB_ENV"   # omit embed
          fi

          # Prepare post text
          title="$(echo "$title" | xargs)"
          preview="$title $url"
          {
            echo "preview=$preview"
            echo "rss_url=$url"
          } >> "$GITHUB_ENV"

          # Debug: show URL bytes to catch hidden characters if any
          echo "DEBUG url (hex):"
          printf '%s' "$url" | hexdump -C || true

          echo "has_today_post=true" >> "$GITHUB_OUTPUT"

      # Post to Bluesky only when today's post exists
      - name: Post to Bluesky
        if: steps.fetch_post.outputs.has_today_post == 'true'
        uses: myConsciousness/bluesky-post@v5
        with:
          text: "${{ env.preview }}"
          link-preview-url: "${{ env.link_preview_url }}"  # sanitized + validated
          identifier: kyleboas.com                         # use your handle/email if different
          password: ${{ secrets.BSS }}
          service: "https://api.bsky.app"                  # explicit endpoint (recommended)

      # Debug (optional)
      - name: Debug Environment Variables
        if: steps.fetch_post.outputs.has_today_post == 'true'
        run: |
          echo "Preview Text: ${{ env.preview }}"
          echo "RSS URL: ${{ env.rss_url }}"
          echo "Link Preview URL: ${{ env.link_preview_url }}"